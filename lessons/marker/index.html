<!DOCTYPE html>
<html>
  <head>
    <title>Marker</title>
  </head>
  <body>

    <div id="status" ></div>

    <div class="container" >
      <textarea id="edit" ></textarea>
    </div>

    <div id="save" >Save</div>
    <input type="text" id="input" >


    <style type="text/css" >
      html, body {
        overflow: hidden;
      }

      #status {
        position: absolute;
        right: 10px;
        top: 10px;
        z-index: 999;
        padding: 10px;
        color: #fff;
        font-family: monospace;
        font-size: 15px;
        background: rgba(0,0,0, 0.3);
      }

      #status div {
        padding: 5px;
      }

      #status div.line:after,
      #status div.collapsed:after {
        opacity: 0.5;
        margin-left: 10px;
      }

      #status div.line:after {
        content: 'l';
      }

      #status div.collapsed:after {
        content: 'c';
      }

      #status div.line.collapsed:after {
        content: 'cl';
      }

      #status div:hover {
        background: rgba(255, 255, 255, 0.3);
        cursor: not-allowed;
      }

      #input {
        position: absolute;
        font-size: 16px;
        font-weight: bold;
        font-family: monospace;
        box-shadow: 0 0 0 15px rgba(0, 0, 0, 0.5);
        z-index: 99;
        bottom : 15px;
        left : 10px;
        width: 50%;
        outline: none;
        display: none;
      }

      #input.show {
        display: block;
      }

      #edit {
        border: none;
        width: 100%;
        height: 100%;
        outline: none;
        background: none;
        color: #fff;
        font-family: monospace;
        font-size: 15px;
      }

      .container {
        position: absolute;
        display: inline-block;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        padding: 15px;
        background: #372725;
      }

      #save {
        position: absolute;
        bottom: 10px;
        right: 10px;
        background: #090;
        color: #fff;
        border-radius: 100px;
        padding: 8px 15px;
        font-family: sans-serif;
        cursor: pointer;
      }

    </style>


    <script type="text/javascript" >

      var path = require('path');
      var fs = require('fs');
      var yml = require('js-yaml');
      var _ = require('lodash');

      var state = { };

      var statusContainer = document.getElementById('status');
      var saveButton = document.getElementById('save');
      var editor = document.getElementById('edit');
      var nameInput = document.getElementById('input');

      // saves the current state
      function writeContent() {
        updateStatus();
        const output = yml.dump(state.content);
        fs.writeFileSync(state.zoneFile, output);
      }

      // drop an item
      function removeItem(item) {
        delete state.content[state.key][item];
        writeContent();
      }

      // sync the list of props
      function updateStatus() {
        statusContainer.innerHTML = '';
        if (!state.content) return;

        // add each item
        const source = state.content[state.key];
        const keys = _.keys(source);
        keys.sort();
        _.each(keys, function(key) {

          const item = source[key];
          const element = document.createElement('div');
          element.onclick = function() {
            removeItem(key);
          };

          element.className = '';
          if (item.collapsed) element.className += ' collapsed';
          if (item.line) element.className += ' line';

          element.innerText = key;
          statusContainer.appendChild(element);
        });
      }

      window.onload = function() {
        editor.focus();
      };

      // shortcut to open editing
      window.onmouseup = function(event) {
        if (editor.selectionStart === editor.selectionEnd) return;
        setTimeout(() => {
          nameInput.className = 'show';
          nameInput.value = '';
          nameInput.focus();
        }, 250);
      };


      nameInput.onblur = function() {
        nameInput.className = '';
      };

      nameInput.onkeyup = function(event) {
        if (event.keyCode !== 13) return;

        // make sure something was input
        var name = (nameInput.value || '').toString().trim();
        if (name == '') return;

        // check for flags
        let isCollapsed;
        name = name.replace(/\!(collapse|hide)/gi, () => {
          isCollapsed = true;
          return '';
        });

        // check for flags
        let isLine;
        name = name.replace(/\!line/gi, () => {
          isLine = true;
          return '';
        });

        // get the final name
        name = _.snakeCase(_.trim(name));

        // get the indexes and line counts to determine the
        // row and column that this selection falls on
        var rangeStart = editor.value.substr(0, editor.selectionStart);
        var rangeEnd = editor.value.substr(0, editor.selectionEnd);
        var linesStart = rangeStart.split(/\n/g);
        var linesEnd = rangeEnd.split(/\n/g);
        var rowStart = linesStart.length - 1;
        var rowEnd = linesEnd.length - 1;
        var columnStart = linesStart[linesStart.length - 1].length;
        var columnEnd = linesEnd[linesEnd.length - 1].length;

        // check if moving down a line
        const lines = editor.value.split(/\n/g);
        if (lines[rowStart].length === columnStart) {
          columnStart = 0;
          rowStart += 1;
        }

        // save the index info
        state.content[state.key] = state.content[state.key] || { };
        state.content[state.key][name] = {
          start: { row: rowStart, col: columnStart },
          end: { row: rowEnd, col: columnEnd },
        };

        if (isCollapsed) {
          state.content[state.key][name].collapsed = true;
        }

        if (isLine) {
          state.content[state.key][name].line = true;
          state.content[state.key][name].start.col = 0;
          state.content[state.key][name].end.col = 0;
        }

        // write the output
        writeContent();
        nameInput.className = '';
      };

      saveButton.onclick = function() {
        nameInput.className = 'show';
        nameInput.value = '';
        nameInput.focus();
      };

      // no changing the content
      editor.onkeyup = editor.onkeydown = editor.oninput = function(event) {
        event.stopPropagation();
        return false;
      };

      editor.addEventListener('drop', function(event) {
        event.stopPropagation();
        event.preventDefault();

        var zoneFile;
        var zoneContent;
        var zoneFileExists;

        // get the file to load
        var file = event.dataTransfer.files[0].path;
        var dir = path.dirname(file);

        // search directories upwards to find the
        // correct location
        while (dir) {
          if (dir === '/' || dir === '')
            break;

          zoneFile = dir + '/zones.yml';
          if (!fs.existsSync(zoneFile)) {
            dir = path.dirname(dir);
            continue;
          }

          zoneFileExists = true;
          zoneContent = fs.readFileSync(zoneFile).toString();
          break;
        }

        // not a file
        if (!zoneFileExists) {
          alert('not a project file with a zones.yml');
          return false;
        }

        // clean up the name a little
        var project = dir.split('/');
        project = project.splice(-2).join('/');

        // get the zone file info
        state.zoneFile = zoneFile;
        state.content = yml.load(zoneContent) || { };
        editor.value = fs.readFileSync(file).toString();

        // also save the key -- remove the starting
        // directory since that's the project files directory
        state.key = file.substr(dir.length);

        // for snippets, remove the filename
        if (/^\/snippets/.test(state.key)) {
          state.key = state.key.replace(/^\/snippets\//, '')
            .replace(/\..*$/, '');
          console.log('using snippet key', state.key);
        }
        else {
          state.key = state.key.replace(/^\/files/, '');
        }


        // track the directory 
        saveButton.innerHTML = 'Save ' + project;
        updateStatus();

        setTimeout(function() { editor.focus(); }, 1);

        return false;
      });

    </script>
  </body>
</html>